<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meal Planner</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#4a7bed',
                        'secondary-yellow': '#ffd369',
                        'pastel-green': '#a8e6cf',
                        'soft-pink': '#ffaaa5',
                        'category-active': '#e0e7ff', /* Light blue for active category */
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* Basic styling setup */
        body {
            background-color: #f7f9fc;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            width: 100%;
            margin-top: 20px;
        }
        .input-area, .output-area {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 2rem;
            margin-bottom: 2rem;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4a7bed;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Recipe Card Styling */
        .recipe-card {
            border: 1px solid #e0e7ff;
            background-color: #f0f4ff;
        }
        .instruction-step {
            display: flex;
            align-items: flex-start;
            margin-bottom: 2rem; /* Increased margin for image space */
            flex-direction: column;
        }
        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .step-number {
            background-color: #4a7bed;
            color: white;
            border-radius: 50%;
            width: 28px; /* Slightly larger */
            height: 28px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            flex-shrink: 0;
            margin-right: 0.75rem;
            font-size: 0.875rem;
        }
        .step-image-container {
            width: 100%;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .step-image {
            width: 100%;
            height: auto;
            min-height: 150px; /* Placeholder minimum height */
            object-fit: cover;
            background-color: #e5e7eb; /* Light gray background for loading */
            display: block;
        }
        /* Custom category styling for the left pane */
        .category-item {
            padding: 0.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-bottom: 0.25rem;
        }
        .category-item:hover:not(.active) {
            background-color: #f3f4f6;
        }
        .category-item.active {
            background-color: var(--tw-colors-category-active);
            font-weight: 600;
            border: 1px solid var(--tw-colors-primary-blue);
        }
        
        /* Recipe Selection Grid Card */
        .recipe-selection-card {
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .recipe-selection-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 25px -5px rgba(0, 0, 0, 0.15);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                padding: 0 10px;
            }
            .input-area, .output-area {
                padding: 1rem;
            }
        }
    </style>
</head>
<body class="font-sans">

    <div class="container">
        <h1 class="text-4xl font-bold text-center text-primary-blue mb-8">
            Canadian Daycare Meal Planner
        </h1>
        
        <!-- Input Area (Always Visible) -->
        <div class="input-area">
            <!-- Back button for detail view -->
            <button id="backToSelectionBtn" class="hidden flex items-center mb-4 text-primary-blue hover:text-blue-600 font-semibold transition duration-200" onclick="setView('selection')">
                <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                Back to Selection
            </button>

            <h2 class="text-2xl font-semibold text-gray-800 mb-4" id="inputAreaTitle">Menu Idea Generation Conditions</h2>
            
            <!-- Ingredient Selection (Two-Column Hierarchical) -->
            <div id="conditionInputs">
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        ✅ Select Available Ingredients
                    </label>
                    <input type="text" id="ingredientFilter" placeholder="Enter ingredients to filter..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue mb-4">
                    
                    <div class="flex flex-col md:flex-row gap-4">
                        <div id="categorySelector" class="w-full md:w-1/3 p-3 border border-gray-300 rounded-lg max-h-60 overflow-y-auto">
                            <p class="text-center text-gray-500 text-sm py-4">Loading Categories...</p>
                        </div>

                        <div class="w-full md:w-2/3">
                            <div id="subIngredientList" class="p-3 border border-gray-300 rounded-lg max-h-60 overflow-y-auto grid grid-cols-1 sm:grid-cols-2 gap-2 h-full">
                                <p class="text-center text-gray-500 col-span-full mt-12">Select a category on the left to view ingredients.</p>
                            </div>
                        </div>
                    </div>
                    <p class="mt-2 text-xs text-gray-500">Select only the ingredients you currently possess.</p>
                </div>
                
                <!-- Allergy Selection (Checkboxes) -->
                <div class="mb-6">
                    <label for="allergyFilter" class="block text-sm font-medium text-red-600 mb-2">
                        🚫 Select Allergies/Restrictions to Strictly Exclude (Optional)
                    </label>
                    <input type="text" id="allergyFilter" placeholder="Filter allergens (e.g., Milk, Soy)..." class="w-full p-3 border border-red-300 rounded-lg focus:ring-soft-pink focus:border-soft-pink mb-4">
                    
                    <div id="allergyList" class="max-h-48 overflow-y-auto p-3 border border-red-300 rounded-lg grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2">
                        <!-- Checkboxes will be rendered here by JavaScript -->
                    </div>
                    <p class="mt-2 text-xs text-gray-500">Select all known allergies or dietary restrictions that must be excluded.</p>
                </div>
            </div> <!-- End of conditionInputs -->
            
            <button id="generateBtn" 
                    class="w-full flex justify-center items-center px-4 py-3 bg-primary-blue text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition duration-300 focus:outline-none focus:ring-2 focus:ring-primary-blue focus:ring-opacity-50">
                Find Recipes
            </button>
        </div>
        
        <!-- Output Area -->
        <div class="output-area">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4" id="outputAreaTitle">Recommended Recipe List</h2>
            <div id="loading" class="hidden flex justify-center items-center py-8">
                <div class="loading-spinner"></div>
                <p class="ml-3 text-primary-blue font-medium">Searching for recipes matching criteria...</p>
            </div>
            <div id="recipeOutput" class="space-y-6">
                <p class="text-gray-500 text-center py-4">Select ingredients and allergy conditions and press the 'Find Recipes' button.</p>
            </div>
        </div>

        <!-- Message Modal -->
        <div id="modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300">
            <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
                <h3 id="modalTitle" class="text-xl font-bold mb-4 text-primary-blue">Notification</h3>
                <p id="modalMessage" class="mb-6 text-gray-700">Message Content</p>
                <button onclick="closeModal()" class="w-full py-2 bg-primary-blue text-white rounded-lg hover:bg-blue-600">Confirm</button>
            </div>
        </div>

    </div>

    <script type="module">
        const generateBtn = document.getElementById('generateBtn');
        const recipeOutput = document.getElementById('recipeOutput');
        const loadingDiv = document.getElementById('loading');
        const backToSelectionBtn = document.getElementById('backToSelectionBtn');
        const conditionInputs = document.getElementById('conditionInputs');
        const inputAreaTitle = document.getElementById('inputAreaTitle');
        const outputAreaTitle = document.getElementById('outputAreaTitle');
        
        // Ingredient Elements
        const categorySelectorDiv = document.getElementById('categorySelector');
        const subIngredientListDiv = document.getElementById('subIngredientList');
        const ingredientFilterInput = document.getElementById('ingredientFilter');

        // Allergy Elements
        const allergyListDiv = document.getElementById('allergyList');
        const allergyFilterInput = document.getElementById('allergyFilter');

        // Global State
        const checkedIngredientsState = new Set();
        let activeCategory = null;
        let suggestedRecipes = []; // Array to hold all 10 recipes
        let currentView = 'initial'; // 'initial', 'selection', 'detail'

        // ** API Communication Settings **
        // The API key is kept as an empty string to be injected by the environment.
        const apiKey = ""; 
        const TEXT_MODEL = "gemini-2.5-flash-preview-05-20";
        const IMAGE_MODEL = "imagen-3.0-generate-002";
        
        // The URL includes the 'key=' parameter to allow injection by the environment.
        const TEXT_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${TEXT_MODEL}:generateContent?key=${apiKey}`;
        const IMAGE_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${IMAGE_MODEL}:predict?key=${apiKey}`;

        // System prompt updated to request 10 recipes with image prompts for each step
        const systemPrompt = "You are an expert in Canadian daycare meal planning. You must only use the provided ingredient list, strictly adhere to the allergy list, and generate exactly ten (10) distinct recipes suitable for toddlers (low-sodium/eco-friendly diet) in JSON array format only. Each recipe object must be complete and contain a detailed 'imagePrompt' for the main dish and a 'stepImagePrompt' for every instruction step, suitable for high-quality image generation. All ingredients must be clearly specified with quantities in grams (g), milliliters (ml), or cups. The servingSize must be fixed to '10 servings for children'.";


        // ** Data Structures (Same as before) **
        const categorizedIngredients = {
            "Protein (Meat/Fish/Legume)": [
                "Chicken Breast (cooked)", "Ground Turkey (lean)", "White Fish (Cod/Tilvier)", 
                "Tofu (Firm)", "Red Lentils (dried)", "Black Beans (canned, rinsed)", "Chickpeas (canned, rinsed)"
            ],
            "Grains & Starches": [
                "Whole Wheat Flour", "Oats (Rolled)", "Quinoa", "Brown Rice", "Whole Grain Pasta", "Sweet Potato"
            ],
            "Vegetables": [
                "Spinach (Fresh)", "Carrots", "Broccoli", "Cauliflower"
            ],
            "Fruits": [
                "Apple", "Banana", "Pear", "Berries (Frozen)", "Orange"
            ],
            "Dairy/Alternatives & Eggs": [
                "Milk (Almond/Soy Substitute)", "Yogurt (Plain, Soy/Coconut)", "Eggs", "Cheddar Cheese (low sodium)"
            ]
        };
        
        const commonAllergens = [
            "Peanut", "Tree Nuts (e.g., Almond, Walnut, Cashew)", "Milk (Dairy)", "Egg", 
            "Soy", "Wheat (Gluten)", "Fish", "Shellfish", "Sesame",
            "Pork", "Honey (Under 1 Year)", "Caffeine (Avoid)", "Sulphites"
        ];
        
        // ** Utility Functions **

        // Exponential backoff logic for API calls
        async function fetchWithBackoff(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    // The URL already includes the 'key=' parameter, so call fetch directly.
                    const response = await fetch(url, options);
                    
                    if (response.status === 429) { 
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        console.warn(`Rate limit hit. Retrying in ${delay / 1000}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    if (!response.ok) {
                        const errorText = await response.text();
                        // Add specific console log for 401 error (API Key failure)
                        if (response.status === 401) {
                            console.error("401 Authentication Error (API Key failure): Please check if the key is provided correctly via the '?key=' URL parameter in the Canvas environment. This is likely not a code issue.");
                        }
                        // Throw error including the status
                        throw new Error(`HTTP error! status: ${response.status} - ${errorText.substring(0, 50)}...`);
                    }
                    return response;
                } catch (error) {
                    console.error('Fetch attempt failed:', error.message);
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        function showModal(title, message) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('modal').classList.remove('hidden');
        }

        window.closeModal = function() {
            document.getElementById('modal').classList.add('hidden');
        }

        // =========================================================================
        // VIEW MANAGEMENT
        // =========================================================================

        /**
         * Switches the application view between 'selection' (input) and 'detail' (recipe list/detail).
         * @param {string} view 'selection' or 'detail'
         */
        window.setView = function(view, recipeIndex = -1) {
            currentView = view;
            
            // Toggle input visibility and back button
            if (view === 'selection') {
                conditionInputs.classList.remove('hidden');
                generateBtn.classList.remove('hidden');
                backToSelectionBtn.classList.add('hidden');
                inputAreaTitle.textContent = 'Menu Idea Generation Conditions';
                outputAreaTitle.textContent = 'Recommended Recipe List';
                renderRecipeSelection();

            } else if (view === 'detail' && recipeIndex >= 0) {
                conditionInputs.classList.add('hidden');
                generateBtn.classList.add('hidden');
                backToSelectionBtn.classList.remove('hidden');
                
                const recipe = suggestedRecipes[recipeIndex];
                inputAreaTitle.textContent = recipe.recipeName; // Use the recipe name as the header
                outputAreaTitle.textContent = 'Detailed Cooking Steps';
                renderRecipeDetail(recipe);
            }
        }

        // =========================================================================
        // IMAGE GENERATION
        // =========================================================================

        /**
         * Generates an image using the Imagen API.
         * @param {string} prompt The text prompt for image generation.
         * @returns {Promise<string>} Base64 data URL of the generated image.
         */
        async function generateImage(prompt) {
            const payload = { 
                instances: [{ prompt: prompt }], 
                parameters: { "sampleCount": 1, "aspectRatio": "1:1" } // Use 1:1 for step images
            };

            try {
                // Using the IMAGE_API_URL which includes the key parameter
                const response = await fetchWithBackoff(IMAGE_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();

                if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                    return `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                } else {
                    console.error("Image generation failed. Result:", result);
                    return 'https://placehold.co/150x150/f9fafb/374151?text=Image+Generation+Error';
                }
            } catch (error) {
                console.error("Error during image API call:", error);
                // Inform user about API Key failure if 401 error persists and key is missing
                if (error.message.includes("401") && !apiKey) {
                    return 'https://placehold.co/150x150/fecaca/991b1b?text=Authentication+Error';
                }
                return 'https://placehold.co/150x150/fecaca/991b1b?text=API+Call+Failed';
            }
        }
        
        /**
         * Generates and replaces the image for the main recipe card.
         * @param {string} prompt The image prompt (recipe.imagePrompt).
         * @param {number} index The index of the recipe to update.
         */
        async function generateAndRenderMainImage(prompt, index) {
            const imageElement = document.getElementById(`main-image-${index}`);
            if (!imageElement) return;

            // Generate the image
            const imageUrl = await generateImage(prompt);
            
            // Update the image source
            imageElement.src = imageUrl;
            imageElement.alt = `Main Recipe Image: ${suggestedRecipes[index].recipeName}`;
        }


        // =========================================================================
        // RECIPE RENDERING
        // =========================================================================

        /**
         * Renders the grid of 10 suggested recipes.
         */
        function renderRecipeSelection() {
            if (suggestedRecipes.length === 0) {
                recipeOutput.innerHTML = `<p class="text-gray-500 text-center py-4">No recipe list available. Select conditions and press the generate button.</p>`;
                return;
            }

            // Set the output title and structure
            outputAreaTitle.textContent = `${suggestedRecipes.length} recipes generated.`;
            recipeOutput.innerHTML = `<div id="recipeGrid" class="grid grid-cols-1 sm:grid-cols-2 gap-6"></div>`;
            const grid = document.getElementById('recipeGrid');

            suggestedRecipes.forEach((recipe, index) => {
                const card = document.createElement('div');
                card.className = 'recipe-selection-card bg-white rounded-xl shadow-lg hover:shadow-xl overflow-hidden';
                card.onclick = () => setView('detail', index);

                // Use a placeholder URL and unique ID for asynchronous image loading
                const placeholderUrl = 'https://placehold.co/400x300/e0e7ff/4a7bed?text=Image+Generating...';
                
                card.innerHTML = `
                    <div class="h-48 w-full bg-cover bg-center">
                        <img id="main-image-${index}" src="${placeholderUrl}" alt="Main recipe image generating..." class="w-full h-full object-cover">
                    </div>
                    <div class="p-4">
                        <h4 class="text-xl font-bold text-gray-800 truncate">${recipe.recipeName}</h4>
                        <p class="text-sm text-gray-500 mt-1">${recipe.servingSize}</p>
                    </div>
                `;
                grid.appendChild(card);
                
                // NEW: Start generating the main image asynchronously
                generateAndRenderMainImage(recipe.imagePrompt, index);
            });
        }

        /**
         * Renders the detailed view of a selected recipe and generates instruction images.
         */
        function renderRecipeDetail(recipe) {
            const ingredientsHtml = recipe.ingredientsList.map(item => 
                `<li class="flex items-center text-gray-700">
                    <svg class="w-4 h-4 mr-2 text-pastel-green" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                    ${item}
                </li>`
            ).join('');

            recipeOutput.innerHTML = `
                <div class="recipe-card p-6 border rounded-xl">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-3xl font-extrabold text-primary-blue">${recipe.recipeName}</h3>
                        <span class="px-3 py-1 bg-secondary-yellow text-gray-800 font-semibold text-sm rounded-full">${recipe.servingSize}</span>
                    </div>

                    <div class="mb-6 p-4 bg-white rounded-lg border border-pastel-green">
                        <p class="font-bold text-lg text-pastel-green mb-2">🚫 Allergy and Precaution Notes</p>
                        <p class="text-sm text-gray-700">${recipe.allergyNotes}</p>
                    </div>

                    <!-- Ingredients List -->
                    <div class="mb-8">
                        <p class="font-bold text-xl text-gray-800 mb-3 border-b pb-1">🍲 Required Ingredients</p>
                        <ul class="list-none space-y-2 pl-0">
                            ${ingredientsHtml}
                        </ul>
                    </div>

                    <!-- Instructions with Image Placeholders -->
                    <div>
                        <p class="font-bold text-xl text-gray-800 mb-4 border-b pb-1">🔪 Cooking Steps (Generating step images...)</p>
                        <div id="instructionSteps" class="space-y-4">
                            ${recipe.instructions.map((instruction, index) => `
                                <div class="instruction-step" id="step-${index}">
                                    <div class="step-header">
                                        <div class="step-number">${index + 1}</div>
                                        <p class="text-gray-700 font-medium flex-1">${instruction.step}</p>
                                    </div>
                                    <div class="step-image-container">
                                        <img id="step-image-${index}" src="https://placehold.co/400x200/cccccc/333333?text=Image+generating..." class="step-image" alt="Cooking step image">
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            // Start generating images for each step asynchronously
            recipe.instructions.forEach((instruction, index) => {
                generateInstructionImage(instruction.stepImagePrompt, index);
            });
        }

        /**
         * Generates and replaces the image for a single instruction step.
         * @param {string} prompt The image prompt.
         * @param {number} index The step index to update.
         */
        async function generateInstructionImage(prompt, index) {
            const imageElement = document.getElementById(`step-image-${index}`);
            if (!imageElement) return;

            // Optional: Show a loading indicator on the image itself
            imageElement.alt = "Image generating...";

            const imageUrl = await generateImage(prompt);
            imageElement.src = imageUrl;
            imageElement.alt = `Step ${index + 1} Image`;
        }

        // =========================================================================
        // AI DATA FETCHING
        // =========================================================================

        generateBtn.addEventListener('click', async () => {
            const ingredients = Array.from(checkedIngredientsState).join(', ');
            // Get selected allergies from the DOM
            const selectedAllergyCheckboxes = document.querySelectorAll('#allergyList input[type="checkbox"]:checked');
            const allergies = Array.from(selectedAllergyCheckboxes).map(cb => cb.value).join(', ');

            if (checkedIngredientsState.size === 0) {
                showModal("Input Error", "Please select at least one available ingredient.");
                return;
            }
            
            // NOTE: The previous mandatory check has been removed, making allergy selection optional.

            // UI update: Start loading
            recipeOutput.innerHTML = '';
            loadingDiv.classList.remove('hidden');
            generateBtn.disabled = true;
            generateBtn.textContent = 'Searching for 10 recipe ideas...';
            outputAreaTitle.textContent = 'Searching for Recipe List...';

            // ⭐️⭐️⭐️ Core change: Conditionally append allergy constraints to the query ⭐️⭐️⭐️
            let userQuery = `Please generate 10 recipes that meet the following conditions.\n- Available Ingredients: ${ingredients}`;
            if (allergies) {
                userQuery += `\n- Allergens/Prohibited Ingredients to Strictly Exclude: ${allergies}`;
            }


            // JSON Schema for an array of 10 complete recipe objects
            const responseSchema = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        "recipeName": { "type": "STRING", "description": "Recipe Name" },
                        "imagePrompt": { "type": "STRING", "description": "Detailed image generation prompt describing the final dish." },
                        "servingSize": { "type": "STRING", "description": "Serving size (e.g., 10 servings for children)" },
                        "ingredientsList": { 
                            "type": "ARRAY", 
                            "items": { "type": "STRING", "description": "Ingredient and quantity" } 
                        },
                        "instructions": {
                            "type": "ARRAY",
                            "items": {
                                "type": "OBJECT",
                                properties: {
                                    "step": { "type": "STRING", "description": "Cooking step text." },
                                    "stepImagePrompt": { "type": "STRING", "description": "Detailed image generation prompt describing this step." }
                                },
                                required: ["step", "stepImagePrompt"]
                            }
                        },
                        "allergyNotes": { "type": "STRING", "description": "Final confirmed allergies and precautions" }
                    },
                    required: ["recipeName", "imagePrompt", "servingSize", "ingredientsList", "instructions", "allergyNotes"]
                }
            };

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: responseSchema,
                    temperature: 0.7 // Use a moderate temperature for diversity
                }
            };

            try {
                // Using the TEXT_API_URL which includes the key parameter
                const response = await fetchWithBackoff(TEXT_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    
                    const jsonText = result.candidates[0].content.parts[0].text;
                    suggestedRecipes = JSON.parse(jsonText);
                    
                    if (suggestedRecipes.length > 0) {
                        setView('selection'); // Switch to selection view
                    } else {
                        throw new Error("AI generated an empty recipe list.");
                    }

                } else {
                    throw new Error("Could not find recipes in AI response or format is incorrect.");
                }

            } catch (error) {
                console.error("Error generating AI recipes:", error);
                const errorHtml = `
                    <div class="p-4 bg-red-100 border-l-4 border-red-500 text-red-700 rounded-lg">
                        <p class="font-bold">❌ Failed to Generate AI Recipes</p>
                        <p>Server communication error occurred. Check your internet connection or try again later. (${error.message})</p>
                        ${error.message.includes("401") ? '<p class="mt-2 font-semibold">Note: A 401 error means authentication failed. Please ensure your API key setting is valid.</p>' : ''}
                    </div>
                `;
                recipeOutput.innerHTML = errorHtml;
                showModal("Communication Error", `Failed to generate recipe list. Check console logs. (${error.message})`);
            } finally {
                // UI update: Stop loading
                loadingDiv.classList.add('hidden');
                generateBtn.disabled = false;
                generateBtn.textContent = 'Find Recipes';
            }
        });

        // =========================================================================
        // CATEGORY/INGREDIENT RENDERING LOGIC (MODIFIED FOR CHECKBOX FIX)
        // =========================================================================

        function renderCategories() {
            categorySelectorDiv.innerHTML = '';
            Object.keys(categorizedIngredients).forEach(category => {
                const categoryDiv = document.createElement('div');
                categoryDiv.textContent = category;
                categoryDiv.className = 'category-item text-gray-700';
                categoryDiv.dataset.category = category;

                categoryDiv.addEventListener('click', () => {
                    document.querySelectorAll('.category-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    categoryDiv.classList.add('active');
                    activeCategory = category;
                    ingredientFilterInput.value = '';
                    renderSubIngredients(category);
                });
                categorySelectorDiv.appendChild(categoryDiv);
            });

            if (Object.keys(categorizedIngredients).length > 0) {
                const firstCategory = Object.keys(categorizedIngredients)[0];
                const firstCategoryElement = document.querySelector(`[data-category="${firstCategory}"]`);
                if (firstCategoryElement) {
                    setTimeout(() => firstCategoryElement.click(), 0);
                }
            }
        }

        function renderSubIngredients(category, filterText = '') {
            subIngredientListDiv.innerHTML = '';
            const ingredients = categorizedIngredients[category] || [];
            const filterLower = filterText.toLowerCase();
            const filteredList = ingredients.filter(item => item.toLowerCase().includes(filterLower));

            if (filteredList.length === 0) {
                subIngredientListDiv.innerHTML = `<p class="text-center text-gray-500 col-span-full mt-12">No ingredients match in ${category}.</p>`;
                return;
            }

            const fragment = document.createDocumentFragment();
            filteredList.forEach(item => {
                // Changed to use <label> wrapping the <input>
                const isChecked = checkedIngredientsState.has(item) ? 'checked' : '';
                const itemDiv = document.createElement('label'); // Changed to <label> for larger click area
                itemDiv.className = 'flex items-center cursor-pointer';

                itemDiv.innerHTML = `
                    <input type="checkbox" name="ingredient" value="${item}" ${isChecked} class="h-4 w-4 text-primary-blue border-gray-300 rounded focus:ring-primary-blue cursor-pointer">
                    <span class="ml-2 text-sm font-medium text-gray-700">${item}</span>
                `;
                fragment.appendChild(itemDiv);
            });
            subIngredientListDiv.appendChild(fragment);

            // Event listener is attached to the <input> inside the generated <label>
            subIngredientListDiv.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        checkedIngredientsState.add(e.target.value);
                    } else {
                        checkedIngredientsState.delete(e.target.value);
                    }
                });
            });
        }
        
        ingredientFilterInput.addEventListener('input', (e) => {
            if (activeCategory) {
                renderSubIngredients(activeCategory, e.target.value);
            }
        });

        function renderAllergies(filterText = '') {
            // Read and maintain the current checked state during filtering.
            const currentChecked = Array.from(document.querySelectorAll('#allergyList input[type="checkbox"]:checked')).map(cb => cb.value);
            allergyListDiv.innerHTML = '';
            const filterLower = filterText.toLowerCase();
            const filteredList = commonAllergens.filter(item => item.toLowerCase().includes(filterLower));

            if (filteredList.length === 0) {
                allergyListDiv.innerHTML = '<p class="text-center text-gray-500 col-span-full">No allergens match the filter.</p>';
                return;
            }
            
            const fragment = document.createDocumentFragment();
            filteredList.forEach(item => {
                // Changed to use <label> wrapping the <input>
                const isChecked = currentChecked.includes(item) ? 'checked' : '';
                const itemDiv = document.createElement('label'); // Changed to <label> for larger click area
                itemDiv.className = 'flex items-center cursor-pointer';

                itemDiv.innerHTML = `
                    <input type="checkbox" name="allergy" value="${item}" ${isChecked} class="h-4 w-4 text-soft-pink border-red-300 rounded focus:ring-soft-pink cursor-pointer">
                    <span class="ml-2 text-sm font-medium text-gray-700">${item}</span>
                `;
                fragment.appendChild(itemDiv);
            });
            allergyListDiv.appendChild(fragment);
            
            // Note: Event listeners are implicitly handled by the <label> wrapping the <input> here.
        }
        
        allergyFilterInput.addEventListener('input', (e) => {
            renderAllergies(e.target.value);
        });

        // Initial render
        document.addEventListener('DOMContentLoaded', () => {
            renderCategories();
            renderAllergies();
        });
    </script>
</body>
</html>

